/*
* @version ecomfw.js v2.6.3:1101 01.11.2010
* @author Paul Bronshteyn
* @author Russell Munson
* @comment Built by a geek loaded on caffeine ...
* @copyright (c) Conde Nast Digital
*/
if(typeof CNP==="undefined"||!CNP){var CNP={}}CNP.ecom=(function(){var ab="ecom",W=null,q=null,k=true,Q=false,L={idx:0},ad="",p=[],F=document,y=location,s=y.search,al=ab+"_test",T="ecommerce_test_site",P=0,v=false,H="Please enter a valid ",V=/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i,aj=/(^\d{5}$)|(^\d{5}-\d{4}$)/,R=navigator.userAgent.toLowerCase(),f={safari:/webkit/.test(R),opera:/opera/.test(R),msie:/msie/.test(R)&&!/opera/.test(R),moz:/mozilla/.test(R)&&!/(compatible|webkit)/.test(R)},E=((f.moz||f.safari)?"offset":"scroll")+"Height",U={},ae=function(am){var ap=z("div"),ao=z("iframe"),an=jQuery(window);ap.id=ab+"usc";F.body.style.overflow="hidden";Z(ap.style,{width:F.body.scrollWidth+"px",height:F.body.scrollHeight+"px",filter:"alpha(opacity = 80)",opacity:".80",zIndex:110000000,position:"absolute",left:"0px",top:"0px",background:"#000000"});O(F.body,ap,"ap");aa(true);Z(ao,{id:ab+"usf",src:h(g(am).replace(/^https*:\/\//g,x()),"iframe","true"),width:749,height:669,scrolling:"no"});Z(ao.style,{background:"#ffffff",border:"0px",position:"absolute",zIndex:120000000,left:(an.width()/2-ao.width/2)+"px",top:(an.scrollTop()+(an.height()/7))+"px"});O(F.body,ao,"ap");j("load",ao,function(){try{this.height=this.contentDocument.body[E]+"px"}catch(aq){}});j("resize",window,function(){var ar=e(ab+"usc"),aq=e(ab+"usf");ar.style.width=F.body.scrollWidth+"px";ar.style.height=F.body.scrollHeight+"px";aq.style.left=(an.width()/2-aq.width/2)+"px";aq.style.top=(an.scrollTop()+(an.height()/7))+"px"});ap=ao=null},z=function(an,am){return(am||F).createElement(an)},e=function(an,am){return(am||F).getElementById(an)},l=function(am,an){return(an||F).getElementsByTagName(am)||[]},O=function(an,ao,am){(am==="rm"?an.removeChild(ao):(am==="ap"?an.appendChild(ao):false))},c=function(an,am){an.style.display=(am==="hide"?"none":"block")},Y=function(an,am){an.innerHTML=am},aa=function(ap){var ao=l("select"),an=0,am=ao.length;for(;an<am;an++){ao[an].style.visibility=(ap)?"hidden":""}},g=function(an,am){return(am)?encodeURIComponent(an):decodeURIComponent(an)},o=function(am){return(am&&am.firstChild)?am.firstChild.nodeValue:""},h=function(ao,ap,an){if((a(ao)&&an==null)||a(ap)){return""}var am=new RegExp("(^|[?=&|]+)"+ap+"=([^&|]*)(&|$)?","i"),aq=ao.match(am);if(an==null){return(aq||"")[2]||""}if(aq){return ao.replace(am,(a(an)?"":"$1"+ap+"="+an))}else{return ao+=(ao.match(/\?/)?"&":"?")+ap+"="+an}},ah=function(am){if(L[am].fid){try{L[am].fid.frameElement.style.height=L[am].doc.body[E]+"px"}catch(an){}}},j=function(am,an,ao){if(an.attachEvent){an.attachEvent("on"+am,ao)}else{an.addEventListener(am,ao,false)}an=null},D=function(am,an,ao){if(an.detachEvent){an.detachEvent("on"+am,ao)}else{an.removeEventListener(am,ao,false)}an=null},x=function(){return(location.protocol==="https:"||ai.https)?"https://":"http://"},w=function(){var an=location.hostname.split(":")[0].split("."),am=an.length;return an.slice(am-2,am).join(".")},M=function(){return h(N.get("amg_user_record"),"uid")},C=function(){var am=y.pathname.split("/")[1]||"";return((am!==""?am.match(/^[^\.]*$/):["homepage"])||[""])[0]},ac=function(){q=z("img");j("load",q,d);j("error",q,S);j("abort",q,S);q.src=ai.host+ai.pingPath+"?ts="+(new Date()).getTime()+((ai.user)?"&amgUserId="+ai.user:"")+"&parent.referrer="+g(F.referrer,true);W=setTimeout(S,ai.timeout*1000)},I=function(){clearTimeout(W);D("load",q,d);D("error",q,S);D("abort",q,S);q=null},d=function(){if(!k){return}I();Q=true;if(ai.callalive){X(ai.callalive)}for(var am;am=p.shift();){ak(am)}},S=function(){I();k=Q=false;p=L=null;if(ai.calldead){X(ai.calldead)}},u=function(ao,aq,ap,an){ap=Z(ap,{"js.enc":(ai.jsEnc==="jsesc"?"jsesc":true),encType:L[ao].enc,"js.callback":((L[ao].fid)?"parent.":"")+"CNP.ecom.response","js.reqId":ao,tgt:L[ao].tgt});var am=z("script");am.type="text/javascript";am.id=ab+ao+((an)?an:"");am.src=ai.host+aq+"?ts="+(new Date()).getTime()+"&"+i(ap);O(L[ao].p,am,"ap");am=null},n=function(am){var an=e(ab+am);if(an){O(L[am].p,an,"rm")}an=null},ak=function(am){if(ai.user){L[am].params.amgUserId=ai.user}if(ai.section){L[am].params.section=ai.section}if(L[am].callbefore){X(L[am].callbefore,L[am].fid)}u(am,ai.offerPath,L[am].params)},X=function(an,am){an.func=an.func||"";an.params=an.params||{};am=am||window;if(typeof an.func==="function"){an.func.call(this,an.params)}else{if(typeof am[an.func]==="function"){am[an.func].call(this,an.params)}}},i=function(ao){var an=[],am;for(am in ao){an.push(am+"="+g(ao[am],true))}return an.join("&")},N={get:function(an){var ap=F.cookie.split("; "),ao=[],aq=0,am=ap.length;for(;aq<am;aq++){ao=ap[aq].split("=");if(ao[0]===an){return g(ao.slice(1).join("="))}}return""},del:function(am){return this.set(am,"",{expires:-1})},set:function(an,ap,am){am=am||{};ap=ap||"";if(am.expires){am.expires=am.expires instanceof Date?am.expires.toUTCString():typeof am.expires==="number"?(new Date(+(new Date)+am.expires*60*60*1000)).toUTCString():""}am.path="/";am.domain=ai.domain;var ao=[an+"="+g(ap,true)];if(am.expires){ao.push("expires="+am.expires)}if(am.path){ao.push("path="+am.path)}if(am.domain){ao.push("domain="+am.domain)}if(am.secure){ao.push("secure")}return am.secure&&ao.push("secure"),F.cookie=ao.join(";"),true}},Z=function(am,ao){for(var an in ao){am[an]=ao[an]}return am},b=function(an){an=an||"";var ao=-1,am=an.length;while(an.charCodeAt(--am)<33){}while(++ao<am&&an.charCodeAt(ao)<33){}return an.slice(ao,am+1)},a=function(am){return !/\S/.test(am||"")},ag={required:function(am){return{res:!a(am),msg:this.title+" is required"}},email:function(am){return{res:a(am)||V.test(am),msg:H+"email address"}},zipcode:function(am){return{res:a(am)||aj.test(am),msg:H+"zipcode"}}},J=function(ao,an,am){return function(){var aq=e(ao.name+"_err_"+am),ap={},at=0,ar=an.length;for(;at<ar;at++){ap=ag[an[at]].call(ao,ao.value);if(!ap.res){Y(aq,ap.msg);c(aq);break}c(aq,"hide")}ah(am);return ap.res}},m=function(ap){if(!ap){return{}}var am={},ao=ap.elements,ar,aq=0,an=ao.length;for(;aq<an;aq++){ar=ao[aq];if(ar.tagName!=="FIELDSET"&&ar.type!=="submit"){am[ar.name]=ar.value}}return am},B=function(ax){var am=l("form",L[ax].p)[0],ao=am.elements,ar=0,an=ao.length;if(!am||!an){return false}L[ax].fh=[];for(;ar<an;ar++){var aw=[],at=ao[ar],ap=(at.className)?at.className.split(/\s/):[],au=0,av=ap.length;if(!av){continue}if(at.type==="submit"){L[ax].btn=at;continue}for(;au<av;au++){if(ap[au] in ag){aw.push(ap[au])}}if(aw.length){var aq=new J(at,aw,ax);L[ax].fh.push(aq);j("blur",at,aq)}}j("submit",am,function(aB){if(aB.cancelable){aB.preventDefault()}aB.returnValue=false;var aA=true,az=0,ay=L[ax].fh.length;for(;az<ay;az++){aA&=L[ax].fh[az]()}if(aA){L[ax].btn.disabled="disabled";L[ax].btn.value="Processing";u(ax,ai.subPath,m(aB.srcElement||aB.target));L[ax].frmto=setTimeout(function(){am.reset();L[ax].btn.disabled="";L[ax].btn.value="Submit";var aC=e("frm_error_"+ax,L[ax].doc);Y(aC,"There was an error processing your order.<br />Please try again.");c(aC)},5000)}return false})},r=function(ap){var ao=l("input",L[ap].p),an=0,am=ao.length,aq=h(s,"as"),ar;for(;an<am;an++){ar=ao[an];if(ar.value===aq&&!ar.checked){ar.checked=true;K.apply(ar,[ar])}if(ar.type!=="hidden"){j("change",ar,K)}}},K=function(an){var ao=an.srcElement||an.target||an,am=ao.form.action.split("?");am[1]=((!am[1])?"":"?"+am[1]);ao.form.action=am[0]+h(am[1],"as",ao.checked?ao.value:0)},t=function(am,ao){var an=ao.match(/mboxCreate\(([^\)]*)\)/)[1];if(!an||typeof mbox!=="function"){return}L[am].p.firstChild.className="";j("load",self,function(){G(am,an)})},G=function(an,ao){var am=z("div"),aq=ao.replace(/'/g,"").split(","),ap;am.id="tempmbox"+an;c(am,"hide");O(L[an].p,am,"ap");aq.unshift(am.id);ap=mboxDefine.apply(this,aq);ap.w.addParameter("rid",an);ap.setFetcher(new mboxAjaxFetcher());ap.getUID=function(){var au=this.w.getParameters(),at=0,ar=au.length;for(;at<ar;at++){if(au[at].name==="rid"){return au[at].value}}return 0};aq.shift();mboxUpdate.apply(this,aq);am=null},A={s:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",d:function(aq){var ap,am="",ao=0,an=aq.length;for(;ao<an;ao+=4){ap=(this.s.indexOf(aq.charAt(ao))&255)<<18|(this.s.indexOf(aq.charAt(ao+1))&255)<<12|(this.s.indexOf(aq.charAt(ao+2))&255)<<6|this.s.indexOf(aq.charAt(ao+3))&255;am+=String.fromCharCode((ap&16711680)>>16,(ap&65280)>>8,ap&255)}if(aq.charCodeAt(ao-2)===61){return am.substring(0,am.length-2)}else{if(aq.charCodeAt(ao-1)===61){return am.substring(0,am.length-1)}else{return am}}}},af=function(){var an=z("div"),am=z("a");an.id=al;Y(an,"!!! ATTENTION !!! YOU ARE USING ECOM PREVIEW SERVER !!! ATTENTION !!!<br />");Z(an.style,{zIndex:100000000,backgroundColor:"#FFD700",color:"#809000",padding:"4px",fontWeight:"bold",textAlign:"center",border:"1px solid #333",marginBottom:"10px",position:"fixed",width:"100%",top:"0px"});Y(am,"[ return to normal mode ]");am.href="#";O(an,am,"ap");O(F.body,an,"ap");j("click",am,function(ao){N.del(al);O(F.body,(ao.srcElement||ao.target).parentNode,"rm");y.search=h(s,T,"");return false});an=am=null},ai={pingPath:"status.jsp",offerPath:"targetedOffer.jsp",subPath:"embeddedForm.jsp",showPath:"showOffer.jsp",docDomain:true,domain:w(),host:"magazine."+this.domain,path:"/ecom/",user:M(),section:C(),timeout:2,https:false,callback:null,params:{},cdn:false,onload:false,contentEnc:"xml",jsEnc:"true"};return{start:function(am){if(h(s,"nojoy")==="1"){return k=Q=false}for(var ao in ai){ai[ao]=h(s,ab+ao)||(am||{})[ao]||ai[ao]}if(ai.cdn===false){var an=h(s,T)||N.get(al)||"";if(an){N.set(al,an);j("load",self,af);ai.host=an}else{N.del(al)}}else{N.del(al)}if(ai.docDomain&&ai.domain){F.domain=ai.domain}ai.host=x()+ai.host.replace(/^https*:\/\/|\/+$/g,"")+ai.path;ac();j("load",self,function(){mboxCreate=function(){return false};if(h(s,"ecomupsell")==="true"){ae(g(h(s,"ecomupsellurl")).replace(/^https*:\/\//g,x()))}if(ai.onload){ai.onload=false;for(var ap;ap=p.shift();){ak(ap)}}});ad=h(s,"nojoytgt");P=(h(s,"edebug")==="1")?1:0;if(P){v=h(s,"targetVer")||false}},mbox:function(an,am){if(typeof an.getUID==="function"){u(an.getUID(),ai.showPath,{placementId:am},"mbox")}},setCallback:function(an){var am=an.name;for(var ao=0;ao<an.callback.length;ao++){if(!U[am]){U[am]=[]}U[am].push(an.callback[ao])}},closeiframe:function(){F.body.style.overflow="visible";c(e(ab+"usf"),"hide");c(e(ab+"usc"),"hide");aa(false);setTimeout(function(){O(F.body,e(ab+"usf"),"rm");O(F.body,e(ab+"usc"),"rm")},2000)},request:function(am){if((!k&&!Q)||ad.indexOf(am.pid)!==-1){return}am=am||{};am.doc=(am.fid)?am.fid.document:F;am.p=e(am.pid,am.doc);am.params=am.params||{};if(v){am.params.targetVer=v}if(!am.p){return}am.enc=am.enc||ai.contentEnc;L[++L.idx]=am;if(!Q||ai.onload){return p.push(L.idx)}ak(L.idx)},response:function(ax,ao){if(typeof L[ax]==="undefined"||a(ao)){return}L[ax].code=ao;var at=b((ai.jsEnc==="jsesc"?unescape(ao):A.d(ao))),ay=null;if(a(at)){return}if(L[ax].enc==="xml"){if(typeof DOMParser==="function"||typeof DOMParser==="object"){ay=(new DOMParser()).parseFromString(at,"text/xml");if(ay.documentElement.nodeName==="parsererror"){return}}else{ay=new ActiveXObject("Microsoft.XMLDOM");ay.async="false";ay.loadXML(at);if(ay.parseError.errorCode!==0){return}}if(!ay){return}if(l("targetedOffer",ay)[0]){var ar=b(o(l("content",ay)[0])),an=b((ar.match(/<script[^>]*>([\s\S]*?)<\/script>/i)||[null,null])[1]);if(a(ar)){return}Y(L[ax].p,ar.replace(/<script(.|\s)*?\/script>/g,""));switch(o(l("placementType",ay)[0])){case"Banner":case"Link":if(!an){break}var av=z("script");av.type="text/javascript";av.id=ab+"js"+ax;if(f.msie){av.text=an}else{O(av,F.createTextNode(an),"ap")}O(L[ax].p,av,"ap");O(L[ax].p,av,"rm");av=null;break;case"embeddedForm":B(ax);break;case"autoSub":r(ax);break;case"testPlacement":case"testPlacement_Banner":case"testPlacement_Link":t(ax,an);break;case"testPlacement_autoSub":t(ax,an);r(ax);break;case"testPlacement_embeddedForm":t(ax,an);B(ax);break}if(L[ax].callafter){X(L[ax].callafter,L[ax].fid)}}else{if(l("response",ay)[0]){clearTimeout(L[ax].frmto);var aq=e("frm_error_"+ax,L[ax].doc);if(l("errors",ay)[0]){var am="",aw=l("error",ay),au=0,ap=aw.length;for(;au<ap;au++){am+=o(l("errorMessage",aw[au])[0])+"<br />"}Y(aq,am);c(aq)}else{c(aq,"hide");Y(aq,"");if(l("ccUpsellPage",ay)[0]){ae(o(l("ccUpsellPage",ay)[0]).replace(/^https*:\/\//g,x()))}l("form",L[ax].p)[0].reset()}L[ax].btn.disabled="";L[ax].btn.value="Submit"}}}else{Y(L[ax].p,ao)}ah(ax);n(ax)}}})();

/***************************************
 * Validate Registration URL
 * and Show Popup when validated success
 *
 */
CN.validateRegistration=(function(){
    var url_Param_ecomUpsellURL, url_window=window.location.href;
    return {
        checkSuccessURL : function() {
            if(CN.url.params("ecomUpsell", url_window)=="true") {
                url_Param_ecomUpsellURL=decodeURIComponent(decodeURIComponent(CN.url.params("ecomUpsellURL", url_window)));
                url_Param_ecomUpsellURL=url_Param_ecomUpsellURL.replace(/^https*:\/\//g, window.location.protocol+"//");
                window.open(url_Param_ecomUpsellURL, "PaymentPage", "menubar=1,status=0,resizable=0,toolbar=0,scrollbars=0,width=910,height=560,left="+((screen.width)/3)+",top="+((screen.height)/3));
            }
        }
    };
})();

jQuery(document).ready(function() {
    CN.validateRegistration.checkSuccessURL();
});