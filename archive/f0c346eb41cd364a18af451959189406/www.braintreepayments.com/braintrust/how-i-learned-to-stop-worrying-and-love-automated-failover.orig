<!doctype html>
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<html>
  <head class="gb ">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="google-site-verification" content="r8IbXNLeCkbvClMX7cOlNY_kTyj6dYozfGgddcXal3s" />
  <meta name="msvalidate.01" content="BB72AE67A2508DF5A032AF96318E4319" />

  
    <meta name="description" content="How Braintree uses PostgreSQL and Pacemaker to handle high availability.">
  

  

  

  

  <title>
    
      How I Learned to Stop Worrying and Love Automated Database Failover
    
  </title>

  <link rel="icon" href="/favicon.png" type="image/x-icon">

  <link href="/assets-b37bb3567e/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <link href="/assets-b37bb3567e/css/pygments/bt.css" media="screen, projection" rel="stylesheet" type="text/css" />

  <script src="/assets-b37bb3567e/js/modernizr.js" type="text/javascript"></script>
  <script src="/assets-b37bb3567e/js/jquery.js" type="text/javascript"></script>
  <script src="/assets-b37bb3567e/js/jquery_ujs.js" type="text/javascript"></script>
  <script type="text/javascript" src="/assets-b37bb3567e/js/ga.js"></script>

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1885256-2']);
    _gaq.push(['_trackPageview']);
  </script>

  <script type="text/javascript">
    setTimeout(function(){var a=document.createElement("script");
    var b=document.getElementsByTagName('script')[0];
    a.src=document.location.protocol+"//dnn506yrbagrg.cloudfront.net/pages/scripts/0012/5710.js?"+Math.floor(new Date().getTime()/3600000);
    a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
  </script>

  <script type="text/javascript">
  /* <![CDATA[ */
  var google_conversion_id = 952085453;
  var google_conversion_label = "VwXeCOOYqgQQzdf-xQM";
  var google_custom_params = window.google_tag_params;
  var google_remarketing_only = true;
  /* ]]> */
  </script>
</head>


  <body>
    <div id="container">
      <header class="main_site">
  <div class="navigation_wrapper full">
      <div class="inner">
          <a class="icon icon2-logo hide-text logo" href="/">Braintree</a>
          <ul class="main_navigation lavalamp">
              <li >
                  <a href="/tour/payment-gateway">Tour</a>
              </li>
              <li >
                  <a href="/developers">Developers</a>
              </li>
              <li >
                  <a href="/clients">Clients</a>
              </li>
              <li >
                  <a href="/support">Support</a>
              </li>
              <li >
                  <a href="/pricing">Pricing</a>
              </li>
              <li >
                  <a href="/mobile-payment-processing">Mobile</a>
              </li>
              <li>
                <a href="/tour/international#uk_contact_form">Sign Up</a>
              </li>
          </ul>
          <ul class="contact">
            <li class="c">
              <a href="/contact-us">Contact</a>
            </li>
            <li class="p">
	            
	              <a href="tel:00.800.6005.4600">
	                <em>00.800.6005.4600<span></span></em>
	              </a>
            	
            </li>
          </ul>
      </div>
  </div>
</header>
	<div class="page_leader_wrapper">
	 <div class="page_leader full">
	     <div class="inner">
	         <div class="content">
	             <div class="text">
	                
	             </div>
	         </div>
	     </div>
			
		</div>
	</div>

      <div class="page_wrapper narrow">
        <div class="content_wrapper first_block two_col">
          <div class="main_col">
            <div class="inner default">
              <article class="single">
  <h1>How I Learned to Stop Worrying and Love Automated Database Failover</h1>
	<header>
    <strong class="meta">Posted on November 01, 2012 by Dave Pirotte</strong>
    <div class="share">
  <div>
		<!-- AddThis Button BEGIN -->
		<div class="addthis_toolbox addthis_default_style ">
		<a class="addthis_button_preferred_1"></a>
		<a class="addthis_button_preferred_2"></a>
		<a class="addthis_button_google_plusone" g:plusone:annotation="none"></a> 
		<a class="addthis_button_preferred_3"></a>
		<a class="addthis_button_preferred_4"></a>
		<a class="addthis_button_compact"></a>
		<a class="addthis_counter addthis_bubble_style"></a>
		</div>
		<script type="text/javascript" src="https://s7.addthis.com/js/250/addthis_widget.js#pubid=ra-4fa159077ba8106c"></script>
		<!-- AddThis Button END -->
  </div>
</div>

	</header>

  

<p>For many businesses, eight minutes is not a meaningful amount of time. Earlier this year, one of our primary database servers was hit by a <a href="http://git.kernel.org/?p=linux/kernel/git/tip/tip.git;a=commit;h=4cecf6d401a01d054afc1e5f605bcbfe553cb9b9">particularly nasty bug</a> in the Linux kernel, resulting in approximately eight minutes of downtime for our payment gateway. To put this into perspective, Braintree will process over $5 billion this year. With this kind of volume, over $75,000 passes through our gateway in eight minutes. So, while eight minutes may not sound like much, it actually translates to a meaningful amount of money, which is unacceptable for our customers, and unacceptable for us.</p>

<p>In a <a href="https://www.braintreepayments.com/braintrust/scaling-postgresql-at-braintree-four-years-of-evolution">recent blog post</a> we mentioned that, as of July, we have automated database failover via Pacemaker to reduce downtime in the event of database problems. I wanted to share some more details on how we consider this topic at Braintree and why we think that automated failover is the right thing for us.</p>

<p>There are several challenges and risks that come with this automation.  When a master database fails, you need to decide which replica to promote, generally based on lag time.  You want to decide quickly to shorten downtime, but a suboptimal choice can lead to data loss.  There is a risk of flapping&mdash;where your clustering software passes the master role around the cluster&mdash;possibly causing even more problems.  Further, manual interaction with automated systems can be problematic.  It is important to have means to halt the automation so manual work can take place. It is also important to have means to restore your automation after the manual work is complete.  Possibly the most terrifying risk is that of a <a href="http://en.wikipedia.org/wiki/Split-brain_(Computing)">split brain scenario</a> leading to data inconsistency or corruption. For us, this means the old master failing to shut down and relinquish it’s IP.  There must always be a way to forcibly shut down a node that won’t do as it is told, thus the automation’s <a href="http://en.wikipedia.org/wiki/STONITH">STONITH</a> tools need to be widely used, well tested, and well exercised.</p>

<p>We operate on a few principles that we feel greatly mitigate these risks, and help us cover as many failure cases as possible as conservatively as possible.</p>

<p>First, we take advantage of Postgres 9.1’s synchronous replication. Each master has a synchronous standby server in the same datacenter, and an asynchronous standby in another datacenter. Note that there is no election or other decision making here. There is only one candidate for promotion to the master role.</p>

<p>Second, we forbid flapping. Failover is a one-way operation only. Pacemaker is allowed to promote a synchronous standby into a master role, but it is never allowed to touch a failed master.</p>

<p>Third, we configure Pacemaker to freeze if it gets confused and has no idea what to do. At this point, a human must intervene to sort things out. We use Nagios and PagerDuty to notify the on-call developer of all issues in the Pacemaker cluster so someone is prepared to intervene if Pacemaker has problems failing over.</p>

<p>All of this went through extensive testing before going into production, from STONITH-ing to <code>killall -9 postgres</code>.  And, now that it is in production, we regularly test and exercise the tools involved.</p>

<p>At the end of the day, we are very happy with the solution we ended up with, and have a thorough understanding of what it does and doesn’t do. We’ve restricted the automation actions to those that are well understood. The point isn’t to solve for every case; the point is to solve for the cases that we know how to solve for. Six months ago, I never would have imagined being in favor of any sort of automated database failover, but a lot of reading and extremely thorough testing got me there.</p>


	<footer>
      
      
        <a class="btn basic" href="/blogs/braintrust">View more posts in Braintrust</a>
       
  	  <a href="/tour/payment-gateway" class="info"><span class="icon icon2-info_large"></span><span class="text">Learn about our solutions</span></a>
    <div class="share">
  <div>
		<!-- AddThis Button BEGIN -->
		<div class="addthis_toolbox addthis_default_style ">
		<a class="addthis_button_preferred_1"></a>
		<a class="addthis_button_preferred_2"></a>
		<a class="addthis_button_google_plusone" g:plusone:annotation="none"></a> 
		<a class="addthis_button_preferred_3"></a>
		<a class="addthis_button_preferred_4"></a>
		<a class="addthis_button_compact"></a>
		<a class="addthis_counter addthis_bubble_style"></a>
		</div>
		<script type="text/javascript" src="https://s7.addthis.com/js/250/addthis_widget.js#pubid=ra-4fa159077ba8106c"></script>
		<!-- AddThis Button END -->
  </div>
</div>

	</footer>

  <div id="disqus_thread"></div>
  
    <script type="text/javascript" src="https://disqus.com/forums/braintree-braintrust/embed.js"></script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=braintree-braintrust">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
  
</article>

            </div>
          </div>
          <div class="side_col">
            <div class="inner">
              <div class="blog_icon_wrapper">
                <a href="/blogs/braintrust">
                  <div class="icon2-braintrust"></div>
                </a>
              </div>
              <strong class="blog_tag">Insights from our dev team</strong>
              <hr />
              <h2>Subscribe to Blog Updates</h2>
              <form onsubmit="window.open('http://feedburner.google.com/fb/a/mailverify?uri=braintree', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true" target="popupwindow" method="post" action="http://feedburner.google.com/fb/a/mailverify" class="side_email">
                <input type="email" name="email" placeholder="E-mail address"/><input type="hidden" name="uri" value="braintree"/><input type="hidden" value="en_US" name="loc"/>
                <button type="submit" name="submit" class="btn basic">Subscribe</button>
              </form>
              <a href="http://feeds.feedburner.com/braintree" rel="alternate" type="application/rss+xml" class="rss"><span class="icon icon2-rss"></span>Subscribe via RSS</a>
              <hr />
              <h2>Popular Posts in Braintrust</h2>
<ul class="pop">
  <li><a href="/devblog/switching-datacenters">How We Moved Our Data Center 25 Miles Without Downtime</a></li>
  <li><a href="/devblog/how-braintree-interviews-exceptional-developers">How Braintree Interviews Exceptional Developers</a></li>
  <li><a href="/devblog/untangle-domain-and-persistence-logic-with-curator">Untangle Domain and Persistence Logic with Curator</a></li>
  <li><a href="/devblog/decentralize-your-devops-with-masterless-puppet-and-supply-drop">Decentralize your DevOps with Master-less Puppet and supply_drop</a></li>
</ul>

<hr />

<h2>Our Other Blog</h2>
  <a href="/blogs/blogtree" class="blog_link">
    <span class="icon icon2-blogtree_small"></span>
    <strong>Blogtree</strong>
    <span class="text">Our industry, our solutions</span>
  </a>

            </div>
          </div>
        </div> <!--! end of .content_wrapper -->
      </div> <!--! end of .page_wrapper -->
      <div class="push"></div>
    </div> <!--! end of #container -->
		<div id="country_list">
  <div class="inner">
    <div class="upper">
      <ul>
        <li><a class="us" data-value="us" href="#"><em></em>United States</a></li>
        <li><a class="ca" data-value="ca" href="#"><em></em>Canada</a></li>
        <li><a class="au" data-value="au" href="#"><em></em>Australia</a></li>
      </ul>
    </div>
    <div class="main">
      <ul>
        <li><a class="at" data-value="at" href="#"><em></em>Austria</a></li>
        <li><a class="be" data-value="be" href="#"><em></em>Belgium</a></li>
        <li><a class="bg" data-value="bg" href="#"><em></em>Bulgaria</a></li>
        <li><a class="cy" data-value="cy" href="#"><em></em>Cyprus</a></li>
        <li><a class="cz" data-value="cz" href="#"><em></em>Czech Republic</a></li>
        <li><a class="dk" data-value="dk" href="#"><em></em>Denmark</a></li>
        <li><a class="ee" data-value="ee" href="#"><em></em>Estonia</a></li>
      </ul>
      <ul>
        <li><a class="fi" data-value="fi" href="#"><em></em>Finland</a></li>
        <li><a class="fr" data-value="fr" href="#"><em></em>France</a></li>
        <li><a class="de" data-value="de" href="#"><em></em>Germany</a></li>
        <li><a class="gr" data-value="gr" href="#"><em></em>Greece</a></li>
        <li><a class="hu" data-value="hu" href="#"><em></em>Hungary</a></li>
        <li><a class="is" data-value="is" href="#"><em></em>Iceland</a></li>
        <li><a class="ie" data-value="ie" href="#"><em></em>Ireland</a></li>
      </ul>
      <ul>
        <li><a class="it" data-value="it" href="#"><em></em>Italy</a></li>
        <li><a class="lv" data-value="lv" href="#"><em></em>Latvia</a></li>
        <li><a class="lt" data-value="lt" href="#"><em></em>Lithuania</a></li>
        <li><a class="lu" data-value="lu" href="#"><em></em>Luxembourg</a></li>
        <li><a class="mt" data-value="mt" href="#"><em></em>Malta</a></li>
        <li><a class="nl" data-value="nl" href="#"><em></em>Netherlands</a></li>
        <li><a class="no" data-value="no" href="#"><em></em>Norway</a></li>
      </ul>
      <ul>
        <li><a class="pl" data-value="pl" href="#"><em></em>Poland</a></li>
        <li><a class="pt" data-value="pt" href="#"><em></em>Portugal</a></li>
        <li><a class="ro" data-value="ro" href="#"><em></em>Romania</a></li>
        <li><a class="sk" data-value="sk" href="#"><em></em>Slovakia</a></li>
        <li><a class="si" data-value="si" href="#"><em></em>Slovenia</a></li>
        <li><a class="es" data-value="es" href="#"><em></em>Spain</a></li>
        <li><a class="se" data-value="se" href="#"><em></em>Sweden</a></li>
      </ul>
      <ul>
        <li><a class="ch" data-value="ch" href="#"><em></em>Switzerland</a></li>
        <li><a class="tr" data-value="tr" href="#"><em></em>Turkey</a></li>
        <li><a class="gb" data-value="gb" href="#"><em></em>United Kingdom</a></li>
      </ul>
      <p>We&rsquo;ll be in more countries soon, <a href="/tour/international#other_countries_form">get notified</a>.</p>
    </div>
    <a href="#" class="close">Close</a>
  </div>
</div>

<footer class="main_site">
  <div class="wrap upper">
    <div class="inner">
      <ul class="nav">
        <li><a href="/company/about">About Us</a></li>
        <li><a href="/contact-us">Contact</a></li>
        <li><a href="/company/careers">Join our Team</a></li>
        <li><a href="/blogs">Blogs</a></li>
        <li><a href="https://status.braintreepayments.com">Status</a></li>
        <li><a href="/company/partners">Partnerships</a></li>
      </ul>
      <ul class="social">
        <li class="t"><a href="https://twitter.com/braintree" target="_blank" title="Braintree on Twitter">Twitter</a></li>
        <li class="f"><a href="https://www.facebook.com/braintreepayments" target="_blank" title="Braintree on Facebook">Facebook</a></li>
      </ul>
      <a id="current_country" href="#" class="" data-value=""><em></em>Select your country<span></span></a>
      <form method="post" id="loc_form" action="/set-country-code">
        <select id="loc" name="country_code">
          
            <option class="be" value="be" >Belgium</option>
          
            <option class="bg" value="bg" >Bulgaria</option>
          
            <option class="mt" value="mt" >Malta</option>
          
            <option class="tr" value="tr" >Turkey</option>
          
            <option class="gr" value="gr" >Greece</option>
          
            <option class="gb" value="gb" selected>United Kingdom</option>
          
            <option class="dk" value="dk" >Denmark</option>
          
            <option class="de" value="de" >Germany</option>
          
            <option class="at" value="at" >Austria</option>
          
            <option class="lv" value="lv" >Latvia</option>
          
            <option class="lt" value="lt" >Lithuania</option>
          
            <option class="lu" value="lu" >Luxembourg</option>
          
            <option class="au" value="au" >Australia</option>
          
            <option class="is" value="is" >Iceland</option>
          
            <option class="ie" value="ie" >Ireland</option>
          
            <option class="it" value="it" >Italy</option>
          
            <option class="sk" value="sk" >Slovakia</option>
          
            <option class="si" value="si" >Slovenia</option>
          
            <option class="se" value="se" >Sweden</option>
          
            <option class="fi" value="fi" >Finland</option>
          
            <option class="fr" value="fr" >France</option>
          
            <option class="pl" value="pl" >Poland</option>
          
            <option class="pt" value="pt" >Portugal</option>
          
            <option class="cy" value="cy" >Cyprus</option>
          
            <option class="cz" value="cz" >Czech Republic</option>
          
            <option class="nl" value="nl" >Netherlands</option>
          
            <option class="ch" value="ch" >Switzerland</option>
          
            <option class="no" value="no" >Norway</option>
          
            <option class="ca" value="ca" >Canada</option>
          
            <option class="us" value="us" >United States</option>
          
            <option class="hu" value="hu" >Hungary</option>
          
            <option class="ro" value="ro" >Romania</option>
          
            <option class="ee" value="ee" >Estonia</option>
          
            <option class="es" value="es" >Spain</option>
          
        </select>
      </form>
    </div>
  </div>
  <div class="wrap lower">
    <div class="inner">
      <form method="post" id="newsletter" action="https://www.salesforce.com/servlet/servlet.WebToLead?encoding=UTF-8">
        <input type=hidden name="oid" value="00D500000007MZQ">
        <input type=hidden name="retURL" value="https://www.braintreepayments.com/newsletter-thank-you">
        <input type=hidden name="lead_source" id="lead_source" value="Web: Newsletter">
        <input type="hidden" id="00N50000002QDzt" maxlength="50" name="00N50000002QDzt" size="20" value=""/>
        <label for="email">Email newsletter</label>
        <div class="input_wrapper">
          <input type="text" name="email" id="email" placeholder="E-mail address" class="required"/>
          <input type="checkbox" name="accept_tos" id="accept-tos" value="checked" />
          <input type="submit" class="submit" name="submit" value="subscribe"/>
          <input name="lead_source" type="hidden" value="Newsletter Sign-Up" />
        </div>
      </form>
      <p>
        &copy; 2008-2012 Braintree Payment Solutions, LLC. All rights reserved. 
        <small>Braintree is a registered ISO/MSP of Wells Fargo Bank, N.A., Walnut Creek, CA <a href="/privacy">Privacy Policy</a></small>
      </p>
    </div>
  </div>
</footer>

<script src="/assets-b37bb3567e/js/validateForm.js" type="text/javascript"></script>
<script src="/assets-b37bb3567e/js/slider.js" type="text/javascript"></script>
<script src="/assets-b37bb3567e/js/sticky.js" type="text/javascript"></script>
<script src="/assets-b37bb3567e/js/developers.js" type="text/javascript"></script>
<script src="/assets-b37bb3567e/js/country.js" type="text/javascript"></script>


		<script src="/assets-b37bb3567e/js/plugins.js" type="text/javascript"></script>
<script src="/assets-b37bb3567e/js/script.js" type="text/javascript"></script>
 <div class="squash">
  <div style="display:none;">
    <script type="text/javascript" src="https://www.googleadservices.com/pagead/conversion.js"></script>

    <noscript>
      <div style="display:inline;">
        <img height="1" width="1" style="border-style:none;" alt="" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/952085453/?value=0&amp;label=VwXeCOOYqgQQzdf-xQM&amp;guid=ON&amp;script=0"/>
      </div>
    </noscript>
  </div>
</div>


  </body>
</html>

